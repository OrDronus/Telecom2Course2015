# POP3 Клиент #

### Задание ###
Разработать приложение на языке Python, обеспечивающее функции клиента протокола POP-3.

Приложение должно реализовывать следующие функции:

1. Подключение  к  указанному  серверу  по  IP-адресу  или  доменному имени
2. Получение состояния ящика (количество писем, их суммарная длина)
3. Получение заголовков всех писем сервера  
4. Загрузка выбранных писем
5. Пометка конкретных писем для последующего удаления
6. Удаление помеченных писем
7. Выход из приложения без удаления помеченных писем
8. Подробное протоколирование соединения сервера с клиентом

Разработанное  приложение  должно  предоставлять пользователю настройку следующих параметров:

1. IP-адрес или доменное имя почтового сервера
2. Номер порта сервера (по умолчанию - 110)
3. Имя пользователя
4. Пароль пользователя

### Описание протокола ###

POP3 (Post Office Protocol Version 3) — стандартный интернет-протокол прикладного уровня, используемый клиентами электронной почты для получения почты с удаленного сервера по TCP/IP-соединению.
POP поддерживает простые требования «загрузи-и-удали» для доступа к удаленным почтовым ящикам.

POP3-сервер прослушивает общеизвестный порт 110. Шифрование связи для POP3 запрашивается после запуска протокола, с помощью либо команды STLS (если она поддерживается), либо POP3S, которая соединяется с сервером используя TLS или SSL по TCP-порту 995.

Доступные сообщения клиента фиксируются при открытии почтового ящика POP-сессией и определяются количеством сообщений для сессии, или, по желанию, с помощью уникального идентификатора, присваиваемого сообщению POP-сервером. Этот уникальный идентификатор является постоянным и уникальным для почтового ящика и позволяет клиенту получить доступ к одному и тому же сообщению в разных POP-сессиях. Почта извлекается и помечается для удаления с помощью номера сообщения. При выходе клиента из сессии помеченные сообщения удаляются из почтового ящика.
Альтернативным протоколом для сбора сообщений с почтового сервера является IMAP.

В протоколе РОРЗ оговорены три стадии процесса получения почты: авторизация, транзакция и обновление. После того как сервер и клиент РОРЗ установили соединение, начинается стадия авторизации. На стадии авторизации клиент идентифицирует себя для сервера. Если авторизация прошла успешно, сервер открывает почтовый ящик клиента и начинается стадия транзакции. В ней клиент либо запрашивает у сервера информацию (например, список почтовых сообщений), либо просит его совершить определенное действие (например, выдать почтовое сообщение). Наконец, на стадии обновления сеанс связи заканчивается.

###Реализация приложения###

Разработанное приложение реализует следующие команды протокола POP-3:

- USER – передача серверу идентификационной информации пользователя
- PASS – передача серверу пароля пользователя
- STAT – получение состояния почтового ящика
- LIST – получение списка сообщения почтового ящика
- RETR – получение сообщения
- DELE – пометка сообщения на удаление
- TOP – получение заголовка и нескольких первых строк сообщения
- UIDL – получение уникального идентификатора сообщения
- RSET – сброс всех пометок на удаление сообщений
- QUIT – удаление всех помеченных сообщений и завершение сеанса

Приложение реализовано в консольном виде и позволяет просматривать список доступных писем на сервере, удалять их и просматривать часть письма, находящуюся в формате "text/plain".

###Архитектура приложения###

Приложение состоит из двух модулей main и POP3.

####main####
Содержит реализацию интерфейса для работы пользователя.

####Функции:####

- load_conf - Загрузка конфигурации приложения из файла

####Классы:####

KeepAlive - Нить, после подключения регулярно посылает серверу пустые сообщения, что бы тот не отключился после долгого простоя, в случае если пользователь ничего не делает.

Console - Основной класс обрабатывающий команды пользователя.

- com_list - обработка команды list (выводит список писем с заголовками)
- com_stat - обработка команды stat (вывод кол-ва писем и их общей длины)
- com_delete - обработка команды delete (пометка указанного письма для удаления)
- com_rset - обработка команды rollback (отмена всех пометок на удаление)
- com_uidl - обработка команды uidl (вывод уникального идентификатора писем/письма)
- com_retr - обработка команды retr (получение текста указанного письма)
- com_help - обработка команды help (вывод списка команд и их краткого описания)
- exec_command - расшифровка команды и вызов соответствующего метода для её обработки
- login - получение у пользователя его данных для входа на сервер

####POP3####
Обеспечивает средства для работы с сервером POP3.

####Функции:####

- decode_payload - декодирование текста сообщения
- decode_head - декодирование

####Классы:####

POP3 - Представляет соединение с сервером POP3 и реализует команды доступа к нему.

- connect - соединение с сервером POP3
- sendMsg - отправка сообщения и получение первой строки ответа
- noop - отправка пустого сообщения
- login - выполнение запросов USER и PASS
- stat - выполнение запроса STAT
- list - выполнение запроса LIST
- delete - выполнение запроса DELE
- rset - выполнение запроса RSET
- uidl - выполнение запроса UIDL
- alist - получение расширенного списка писем (загрузка заголовков)
- top - выполнение запроса TOP
- retr - выполнение запроса RETR
- quit - отправка команды QUIT и закрытие соединения

###Работа с приложением###

Основная конфигурация задаётся в файле "conf.txt" в формате:

    hostname имя сервера (IP адрес или доменное имя)
    port номер порта сервера
    ssl использование SSL (True/False)

Если не указать какие то параметры, то будут использованы значения по умолчанию: номер порта - 110, SSL - False. Если не указать имя сервера программа выдаст ошибку и не будет работать.

Работа с приложением осуществляется в консоли, сначала пользователю предлагают ввести имя и пароль, при неудачной попытке входа предложение повторится.

После входа пользователь может использовать команды для работы с приложением. Команды вводятся в формате.

    команда [аргумент]

Список доступных команд:

- list - получение списка писем на сервере
- stst - вывод кол-ва писем и их общей длины
- delete сообщение - удаление выбранного сообщения
- rollback - отмена удаления всех сообщений, удалённых в данной сессии
- uidl [сообщение] - получение уникального идентификатора сообщения или идентификаторов всех сообщений на сервере
- retr сообщение - вывод текстового содержимого выбранного сообщения
- quit - закрытие соединения и выход из программы
- help - вывод списка доступных команд

### Тестирование приложения ###

Для тестирования приложения использовался почтовый сервер Rambler и два почтовых аккаунта. Приложение смогло расшифровать и вывести текстовое содержимое любого из множества сообщений (не во всех сообщениях было текстовое содержимое). Большинство сообщений представляло собой разнообразный спам, так как данный аккаунт давно не использовался, имело достаточно разнообразное содержание и использовало разные способы кодирования. Помимо этого был создан пробный аккаунт и послано на него пробное сообщение, которое так же удалось успешно прочитать. Так же с сервера было успешно удалено несколько сообщений.

### Выводы ###
В ходе работы был изучен язык Python и протокол POP3. Сообщения на сервере хранятся в формате MIME и их заголовки и содержимое закодированы различными методами. К счастью в библиотеке языка Python есть большое количество соответствующих классов и функций для работы с сообщениями, что упростило задачу расшифровки заголовков сообщений и их содержимого. Можно отметить что данный язык имеет большое количество модулей для работы с различными сетевыми протоколами и форматами данных, а так же отличную документацию. При этом RFC1939, описывающий сам протокол, не даёт комментариев касательно возможного содержания сообщений и методов их представления.