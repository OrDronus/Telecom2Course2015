# FTP сервер #

### Задание ###

Разработать приложение на языке Python, обеспечивающее функции FTP-сервера, работающего в пассивном режиме.

Приложение должно реализовывать следующие функции: 

1. Хранение идентификационной и аутентификационной информации нескольких пользователей
2. Поддержка анонимного входа (пользователь anonymous)
3. Обработка подключения клиента
4. Выдача по запросу клиента содержимого каталога
5. Навигация по системе каталогов
6. Создание нового каталога
7. Удаление каталога
8. Посылка по запросу клиента содержимого указанного файла
9. Приём по запросу клиента содержимого указанного файла
10. Удаление указанного файла
11. Протоколирование соединения сервера с клиентом

Разработанное  приложение  должно  обеспечивать:

1. Настройку номера порта сервера (по умолчанию – 21)
2. Настройку корневого каталога сервера для каждого пользователя

### Описание протокола ###

FTP (File Transfer Protocol — Протокол Передачи Файлов) - стандартный протокол, предназначенный для передачи файлов по TCP-сетям (например, Интернет). По умолчанию использует 21й порт.

Протокол построен на архитектуре «клиент-сервер» и использует разные сетевые соединения для передачи команд и данных между клиентом и сервером. Пользователи FTP могут пройти аутентификацию, передавая логин и пароль открытым текстом, или же, если это разрешено на сервере, они могут подключиться анонимно. Можно использовать протокол SSH для безопасной передачи, скрывающей (шифрующей) логин и пароль, а также шифрующей содержимое.

Протокол определен в RFC 959. Сервер отвечает по потоку управления трехзначными ASCII-кодами состояния с необязательным текстовым сообщением. Например, «200» (или «200 ОК») означает, что последняя команда была успешно выполнена. Цифры представляют код ответа, а текст — разъяснение или запрос. Текущая передача по потоку данных может быть прервана с помощью прерывающего сообщения, посылаемого по потоку управления.
FTP может работать в активном или пассивном режиме, от выбора которого зависит способ установки соединения. В активном режиме клиент создаёт управляющее TCP-соединение с сервером и отправляет серверу свой IP-адрес и произвольный номер клиентского порта, после чего ждёт, пока сервер запустит TCP-соединение с этим адресом и номером порта. В случае, если клиент находится за брандмауэром и не может принять входящее TCP-соединение, может быть использован пассивный режим. В этом режиме клиент использует поток управления, чтобы послать серверу команду PASV, и затем получает от сервера его IP-адрес и номер порта, которые затем используются клиентом для открытия потока данных с произвольного клиентского порта к полученному адресу и порту.

Модель протокола

                                            -------------
                                            |/---------\|
                                            ||   User  ||    --------
                                            ||Interface|<--->| User |
                                            |\----^----/|    --------
                  ----------                |     |     |
                  |/------\|  FTP Commands  |/----V----\|
                  ||Server|<---------------->|   User  ||
                  ||  PI  ||   FTP Replies  ||    PI   ||
                  |\--^---/|                |\----^----/|
                  |   |    |                |     |     |
      --------    |/--V---\|      Data      |/----V----\|    --------
      | File |<--->|Server|<---------------->|  User   |<--->| File |
      |System|    || DTP  ||   Connection   ||   DTP   ||    |System|
      --------    |\------/|                |\---------/|    --------
                  ----------                -------------

                  Server-FTP                   USER-FTP

При передаче данных по сети могут быть использованы четыре представления данных:

- ASCII — используется для текста;
- Режим изображения (обычно именуемый бинарным);
- EBCDIC — используется для передачи обычного текста между хостами в кодировке EBCDIC;
- Локальный режим — позволяет двум компьютерам с идентичными установками посылать данные в собственном формате без конвертации в ASCII;

Передача данных может осуществляться в любом из трёх режимов:

- Поточный режим — данные посылаются в виде непрерывного потока, освобождая FTP от выполнения какой бы то ни было обработки. Вместо этого, вся обработка выполняется TCP. Индикатор конца файла не нужен, за исключением разделения данных на записи.
- Блочный режим — FTP разбивает данные на несколько блоков (блок заголовка, количество байт, поле данных) и затем передаёт их TCP.
- Режим сжатия — данные сжимаются единым алгоритмом (обычно, кодированием длин серий).

### Реализация приложения ###

Разработанное приложение реализует следующие команды протокола FTP:

* USER  –  получение  от  клиента  идентификационной  информации
пользователя
* PASS – получение от клиента пароля пользователя
* LIST – отправка клиенту расширенной информации о списке файлов
каталога
* CWD – смена текущего каталога сервера
* CDUP - смена директории на вышестоящую
* MKD – создание каталога
* RMD – удаление каталога
* DELE – удаление файла на сервере
* PASV – перевод сервера в пассивный режим
* RETR – посылка файла клиенту
* STOR – запись полученного от клиента файла
* DELE – удаление файла
* TYPE – задание режима передачи данных
* RNFR - имя файла для переименования
* RNTO - новое имя переименовываемого файла
* NOOP - пустая операция (всегда положительный ответ)
* SYST - запрос информации об операционной системе сервера
* FEAT - получение списка поддерживаемых доп. команд
* OPTS - задание настроек доп. команд
* QUIT – удаление всех помеченных сообщений и завершение сеанса

Приложение поддерживает бинарный режим для передачи файлов и ASCII для передачи списка файлов каталога. Для передачи данных используется поточный режим.

Формат списка файлов:

    drwxrwxrwx 1 server server 4096 Nov 11 12:20 Library
    -rw-rw-rw- 1 server server 44 Nov 11 14:17 link.txt

###Архитектура приложения###

####Функции:####

- loadConf - Загрузка конфигурации сервера из файла
- loadUsers - Загрузка информации о пользователях (имя, пароль, корневая папка)
- list_dir - Формирует список файлов в папке

####Классы:####

ConnectionClosedError - Исключение, выбрасываемое при прерывании соединения

NotEnoughParametersError - Исключение, выбрасываемое при недостаточном кол-ве параметров команды

Logger - Монитор, используемый для протоколирования работы сервера

- write - Запись события в протокол

MySocket - Обеспечивает более удобную работу с сокетами

- send - посылка сообщения
- recv - получение сообщения
- close - закрытие сокета
- getsockname - получение адреса сокета
- getpeername - получение адреса на другом конце соединения

Client - Реализует команды сервера и обеспечивает работу с клиентом

- getDirPath - определение пути подпапки
- recvComm - получение команды
- sendResp - отправка ответного сообщения
- noLoginResp - отправка ответа при попытке вызвать команду, требующую входа в систему
- anonAccResp - отправка ответа при попытке вызвать команду не доступную при анонимном доступе
- login - обработка команды USER и PASS (вход пользователя в систему)
- anonPass - отправка ответа на команду PASS при анонимном доступе
- syst - обработка команды SYST
- noop - обработка команды NOOP
- opts - обработка команды OPTS
- feat - обработка команды FEAT
- pwd - обработка команды PWD
- cwd - обработка команды CWD
- cdup - обработка команды CDUP
- pasv - обработка команды PASV
- type - обработка команды TYPE
- list - обработка команды LIST
- retr - обработка команды RETR
- stor - обработка команды STOR
- rename - обработка команд RNFR и RNTO
- dele - обработка команды DELE
- rmd - обработка команды RMD
- mkd - обработка команды MKD
- run - основной цикл работы с клиентом, принимает команды, определяет их и вызывает соответствующий метод для их обработки

###Работа с приложением###

Основная конфигурация задаётся в файле "conf.txt" в формате:

    def_root Путь к корневой папке по умолчанию
    anon_root Путь к корневой папке для анонимного доступа
    port Номер порта

Если не указать какие то параметры, то будут использованы значения по умолчанию: номер порта - 21, корневая папка будет находиться в рабочей папке приложения, а анонимный доступ не будет доступен.

На сервер можно зайти используя анонимный доступ (логин - anonymous), при этом пароль можно не присылать, но при его получении сервер повторно отправляет сообщение об успешном входе в систему. При использовании анонимного доступа пользователь может переходить по папкам сервера и скачивать файлы, но не может никаким образом их менять (записывать, удалять, переименовывать).

Список пользователей задаётся в файле "users.txt" в формате:

    логин пароль путь к корневой папке пользователя

Если не указывать корневую папку пользователя, будет использована корневая папка по умолчанию, которая задаётся в конфигурационном файле.

Пример:

    andrew 12345 D:/
    bob hello

Так же сервер поддерживает опцию UTF8 и позволяет передовать имена файлов в юникоде после включения соответствующей опции.

### Тестирование приложения ###

Тестирование приложения проводилось в локальной домашней сети с использованием FTP клиентов WinSCP и Проводник (Windows) на компьютере и X-plore на платформе Android.

Все три приложения распознали формат списка файлов, свободно переходили по папкам и успешно передавали файлы в обоих направлениях. При использовании анонимного входа, приложения выдавали ошибку при попытке записать фалы на сервер, удалить файлы и папки с сервера.

### Выводы ###
В ходе работы был изучен протокол FTP и было продолжено изучение языка Python. Не смотря на то, что в RFC указано, что соединение для передачи файлов должно быть полностью независимо от соединений данных. И в рамках одной сессии можно организовывать несколько соединений для передачи файлов, при этом используя функцию ABORT для отмены передачи. Не один из использованных клиентов не позволял совершать никаких действий при передаче файла, а Проводник для передачи нескольких файлов одновременно открывал несколько сессий (по одной на каждую передачу). При отмене передачи клиенты просто закрывали соединение (что считается корректным завершением передачи при использовании потокового режима), таким образом сервер никак не мог определить была ли передача корректно завершена. При отмене записи файла на сервер X-plore отдельной командой удалил недозаписанный файл с сервера, а WinSCP ничего не предпринял. Так же надо отметить, что Проводник часть команд присылал в нижнем регистре, хотя в RFC указано, что все команды должны быть исключительно в верхнем (сервер был доработан, для работы с Проводником). При этом все клиенты поддерживали опцию UTF8 и пытались её включить после установления соединения. Судя по всему большинство FTP реализаций обеспечивают лишь самую базовую и необходимую функциональность.
